# TLinker
TLinker 是一个BT辅助工具，目前提供三种功能：
- **Autolink**: 根据提供的种子（.torrent），从原始位置查找匹配的文件，并链接到目标位置。
- **Link**: 将原始位置的目录结构复制到目标位置，并将原始位置中的所有文件链接到目标位置中的对应路径。
- **Tree**: 根据提供的种子（.torrent），在目标位置中建立相同的目录结构。

## 适用场景
- 希望修改已下载的种子的文件结构，但同时希望继续对该种子进行做种。
- 希望利用已有的文件对种子进行辅种，但已有文件的结构与该种子要求的文件结构不一致。

## 使用方法
```shell
java -jar tlinker-*.*.jar <功能> <选项>
```

### AutoLink
```shell
java -jar tlinker-*.*.jar autolink -t <种子文件> -s <原始位置> -d <目标位置> [-h] [-e] [-q]
```
对于`种子文件`包含的每个文件，在`原始位置`中查找与其一致的文件，若查找成功，则在`目标位置`的对应路径中创建一个文件链接

- `-t`: （必须）种子文件路径，需要读权限
- `-s`: （必须）原始位置，文件夹，需要读权限
- `-d`: （必须）目标位置，文件夹，需要读写权限
- `-h`: （可选）使用硬链接而非软链接
- `-e`: （可选）不进行链接，而是生成包含链接命令的脚本。脚本位于jar文件同级目录下，Windows平台下名为`tlinker-####.bat`；Linux平台下名为`tlinker-####.sh`。
- `-q`: （可选）关闭除错误信息之外的输出

### Link
```shell
java -jar tlinker-*.*.jar link -s <原始位置> -d <目标位置> [-h]
```
对于`原始位置`中的每个文件，在`目标位置`的对应路径中创建一个文件链接

- `-s`: （必须）原始位置，文件夹，需要读权限
- `-d`: （必须）目标位置，文件夹，需要读写权限
- `-h`: （可选）使用硬链接而非软链接

### Tree
```shell
java -jar tlinker-*.*.jar tree -t <种子文件> -d <目标位置> [-f]
```
在`目标位置`处创建`种子文件`中包含的文件和文件夹

- `-t`: （必须）种子文件路径，需要读权限
- `-d`: （必须）目标位置，文件夹，需要读写权限
- `-f`: （可选）同时在对应位置建立同名的空文件

### 示例

假设种子`/downloads/贝多芬作品.torrent`包含以下文件：
> 钢琴奏鸣曲/悲怆.mp3\
> 钢琴奏鸣曲/月光.mp3\
> 交响曲/英雄.mp3\
> 交响曲/命运.mp3

假设文件夹`/media/贝多芬作品集/`包含以下文件：
> 1790/街头之歌.mp3\
> 1790/悲怆.mp3\
> 1800/春.mp3\
> 1800/月光.mp3\
> 1800/致希望.mp3\
> 1800/英雄.mp3\
> 1800/命运.mp3

假设文件夹`/home/贝多芬作品/`是一个空文件夹。

#### AutoLink

```shell
java -jar tlinker-*.*.jar autolink -t /downloads/贝多芬作品.torrent -s /media/贝多芬作品集/ -d /home/贝多芬作品/
```

运行此命令后，`/home/贝多芬作品/`会增加以下内容：
> **钢琴奏鸣曲/悲怆.mp3** *-> /media/贝多芬作品集/1790/悲怆.mp3*\
> **钢琴奏鸣曲/月光.mp3** *-> /media/贝多芬作品集/1800/月光.mp3*\
> **交响曲/英雄.mp3** *-> /media/贝多芬作品集/1800/英雄.mp3*\
> **交响曲/命运.mp3** *-> /media/贝多芬作品集/1800/命运.mp3*

#### Link
```shell
java -jar tlinker-*.*.jar link -s /media/贝多芬作品集/ -d /home/贝多芬作品/
```

运行此命令后，`/home/贝多芬作品/`会增加以下内容：
> **1790/街头之歌.mp3** *-> /media/贝多芬作品集/1790/街头之歌.mp3*\
> **1790/悲怆.mp3** *-> /media/贝多芬作品集/1790/悲怆.mp3*\
> **1800/春.mp3** *-> /media/贝多芬作品集/1800/春.mp3*\
> **1800/月光.mp3** *-> /media/贝多芬作品集/1800/月光.mp3*\
> **1800/致希望.mp3** *-> /media/贝多芬作品集/1800/致希望.mp3*\
> **1800/英雄.mp3** *-> /media/贝多芬作品集/1800/英雄.mp3*\
> **1800/命运.mp3** *-> /media/贝多芬作品集/1800/命运.mp3*

#### Tree
```shell
java -jar tlinker-*.*.jar tree -t /downloads/贝多芬作品.torrent -d /home/贝多芬作品/
```
运行此命令后，`/home/贝多芬作品/`会增加以下内容：
> **钢琴奏鸣曲/** *空文件夹*\
> **交响曲/** *空文件夹*

## 编译
```shell
mvn clean package
```

## 技术细节

### torrent文件结构
&emsp;&emsp;种子文件是一个经过Bencode编码的文本文件，以键值对的形式存储了这个种子的数据，每个多文件种子都包含的数据有：
- `announce` *Tracker地址*
- `info`
    - `piece length` *每一个块的大小（字节）*
    - `pieces` *每一个块的SHA-1校验值*
    - `name` *种子的名字*
    - `files` *种子包含的文件列表*
        - `length` *文件大小（字节）*
        - `path` *文件相对路径*

&emsp;&emsp;种子将其包含的文件按照固定顺序拆分为多个块，每个块拥有固定的大小，然后记录每个块的SHA-1校验值以供校验使用。因此在多文件种子中，一个文件的数据可能会分别位于多个连续的块中，一个块也可能会包含多个文件的数据。


### 文件链接
&emsp;&emsp;文件链接是一种建立多个文件之间联系的机制，其功能类似快捷方式。文件链接分为硬链接和软链接（又名符号链接）。若创建位置A的链接到位置B，则访问位置B时也能访问到位置A对应文件的内容，但该文件只占用一份存储空间。\
&emsp;&emsp;若软链接的原文件被移动或删除，则通过软链接不再能访问原文件；若硬链接的原文件被移动，通过硬链接仍然能访问原文件；若硬链接的原文件被删除，通过硬链接仍能访问原文件，若再删除硬链接，则原文件被删除。\
&emsp;&emsp;在Linux平台中，软链接支持链接文件和文件夹，当链接文件夹时，只有文件夹本身被链接，文件夹内部的文件不会被链接，若使用递归删除命令删除链接，则原文件夹内部的文件也一同被删除，因此出于安全考虑，本程序不会对文件夹进行链接，而是对文件夹内部的所有文件进行链接。

### AutoLink模式的匹配原理
&emsp;&emsp;运行于AutoLink模式时，本程序首先读取`种子文件`的文件列表，对于该列表中的每一个文件，在提供的`原始位置`中查找与该文件大小一致的文件，将它们添加到该文件的匹配候选中；然后统计该种子块的数量，对于每一个块：
1. 查找这个块包含的文件：如果某个文件没有匹配候选，则这个文件在`原始位置`中找不到匹配的文件，这个块校验失败，这个块包含的所有文件也校验失败；如果某个文件的匹配候选多于一个，则自动选择文件名最相似的匹配候选。
2. 计算这个块包含的文件部分：由于每个块的大小是一致的，而每个文件的大小是不一致的，因此一个块可能会包含某些文件的某一部分，一个文件可能会分布于多个块中。将这些文件按照正确的方式切割并拼接，得到这一个块的实际数据。
3. 对这个块的数据进行SHA-1校验，并与种子文件中该块的校验值比对，若校验值一致，则这个块校验通过。若校验值不一致，则该块中有一个或多个文件不匹配，这可能是因为在`原始位置`中存在大小相同但文件内容不同的文件，在原理上无法得知具体哪一个文件不匹配，因此对于存在多个候选的文件，用户需要手动选择，如果不存在有多个候选的文件，则这个块校验失败。

&emsp;&emsp;所有块校验完成后，对于种子文件列表中的每一个文件，如果文件所属的每一个块都通过校验，则该文件校验通过，程序会对该文件进行链接；如果文件所属的某一个块没有通过校验，则该文件校验失败，程序无法对该文件进行链接。

如果没有发生校验失败，则种子中的所有文件都可在`原始位置`中找到，在`目标位置`将会生成与种子文件完全一致的结构，此时`目标位置`可直接用于做种或辅种。如果发生校验失败，程序会打印失败的文件，需要手动处理失败的文件。

### AutoLink模式的匹配准确度

程序使用文件大小作为首要匹配指标，以文件路径相似度作为辅助匹配指标，因此如果种子和`原始位置`都不存在大小相同但文件内容不同的文件，且种子中的所有文件都存在于`原始位置`中，则无论文件名和目录结构是否修改，整个种子都能够全部匹配成功。\
如果种子中有部分文件在`原始位置`不存在，则除了这些文件无法链接外，它们相邻的文件也可能也会无法链接。\
如果种子或`原始位置`中存在大小相同但文件内容不同的文件，且这些文件的文件名和路径被修改过，则有可能匹配失败。

## 许可证
本项目基于 Apache 许可证发布，详见`LICENSE`文件。